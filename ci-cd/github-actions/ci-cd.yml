# ==============================================================================
# GitHub Actions CI/CD Pipeline
# ==============================================================================
# Comprehensive pipeline with:
# - Code quality checks
# - Security scanning
# - Testing (unit, integration)
# - Docker build & push
# - Kubernetes deployment
# ==============================================================================

name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  PYTHON_VERSION: "3.11"

jobs:
  # ===========================================================================
  # Code Quality & Linting
  # ===========================================================================
  lint:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install black flake8 mypy isort bandit
      
      - name: Run Black (code formatter)
        run: black --check app/
      
#      - name: Run isort (import sorter)
#        run: isort --check-only app/
      
#      - name: Run Flake8 (linter)
#        run: flake8 app/ --max-line-length=120 --exclude=__pycache__
#
      - name: Run MyPy (type checker)
        run: mypy app/ --ignore-missing-imports
      
#      - name: Run Bandit (security linter)
#        run: bandit -r app/ -f json -o bandit-report.json
      
      - name: Upload Bandit Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bandit-report
          path: bandit-report.json

  # ===========================================================================
  # Security Scanning - Dependencies
  # ===========================================================================
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    permissions: # <--- ADD THIS BLOCK
      contents: read      # <--- ADD THIS
      security-events: write # <--- CRITICAL FOR THE FIX
    steps:
      - uses: actions/checkout@v4
      
      - name: Run Safety (dependency security scan)
        run: |
          pip install safety
          safety check --json --file requirements.txt || true
      
      - name: Run Trivy (vulnerability scanner)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
      
      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # ===========================================================================
  # Unit Tests
  # ===========================================================================
  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio
      
      - name: Run tests with coverage
        run: |
          export PYTHONPATH=$PYTHONPATH:$(pwd)
          pytest tests/ \
            --cov=app \
            --cov-report=xml \
            --cov-report=html \
            --junitxml=junit.xml \
            -v
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: unittests
      
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: |
            junit.xml
            htmlcov/

  # ===========================================================================
  # Build & Push Docker Image
  # ===========================================================================
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [lint, test, security-scan]
    permissions:
      contents: read
      packages: write
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      image-digest: ${{ steps.build.outputs.digest }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
      
      - name: Build and push (Production)
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/production/Dockerfile
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64
      
      - name: Scan Docker image with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ steps.meta.outputs.tags }}
          format: 'sarif'
          output: 'trivy-image-results.sarif'
      
      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-image-results.sarif'

  # ===========================================================================
  # Deploy to Kubernetes (Development)
  # ===========================================================================
  deploy-dev:
    name: Deploy to Development
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/develop'
    environment:
      name: development
      url: https://dev-api.company.com
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-west-2
      
      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig \
            --name dev-cluster \
            --region us-west-2
      
      - name: Deploy to Kubernetes
        run: |
          kubectl set image deployment/sre-demo-api \
            api=${{ needs.build.outputs.image-tag }} \
            -n development
          
          kubectl rollout status deployment/sre-demo-api \
            -n development \
            --timeout=5m
      
      - name: Run smoke tests
        run: |
          kubectl run smoke-test \
            --image=curlimages/curl:latest \
            --restart=Never \
            --rm \
            -i \
            --namespace=development \
            -- curl -f http://sre-demo-api/health/live

  # ===========================================================================
  # Deploy to Kubernetes (Production)
  # ===========================================================================
  deploy-prod:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://api.company.com
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-west-2
      
      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig \
            --name prod-cluster \
            --region us-west-2
      
      - name: Deploy to Kubernetes
        run: |
          kubectl set image deployment/sre-demo-api \
            api=${{ needs.build.outputs.image-tag }} \
            -n production
          
          kubectl rollout status deployment/sre-demo-api \
            -n production \
            --timeout=10m
      
      - name: Run smoke tests
        run: |
          kubectl run smoke-test \
            --image=curlimages/curl:latest \
            --restart=Never \
            --rm \
            -i \
            --namespace=production \
            -- curl -f http://sre-demo-api/health/live
      
      - name: Notify deployment
        run: |
          echo "Deployed ${{ needs.build.outputs.image-tag }} to production"
          # Add Slack/PagerDuty/DataDog notification here

  # ===========================================================================
  # Load Testing (Post-deployment)
  # ===========================================================================
  load-test:
    name: Load Test
    runs-on: ubuntu-latest
    needs: deploy-dev
    if: github.ref == 'refs/heads/develop'
    steps:
      - uses: actions/checkout@v4
      
      - name: Install k6
        run: |
          curl https://github.com/grafana/k6/releases/download/v0.48.0/k6-v0.48.0-linux-amd64.tar.gz -L | tar xvz --strip-components 1
      
      - name: Run load test
        run: |
          ./k6 run tests/load/basic-load-test.js \
            --out json=results.json
      
      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: load-test-results
          path: results.json
